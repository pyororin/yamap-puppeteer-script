# YAMAPタイムライン巡回スクリプト 設計仕様書 (最終版)

## 1. 概要

このドキュメントは、YAMAPタイムライン巡回スクリプトの最終的な技術仕様を定義します。スクリプトは指定されたYAMAPのタイムラインまたは活動日記一覧ページを巡回し、まだリアクションを送っていない投稿に自動で「いいね！」（絵文字リアクション）を送ることを目的とします。

## 2. アーキテクチャ

### 2.1. 最終的な技術スタック

- **言語:** Go
- **ライブラリ:** `github.com/chromedp/chromedp`
- **実行方式:** **モノリシック・インメモリセッション方式**

### 2.2. アーキテクチャ決定の経緯と理由

開発初期段階において、複数のアプローチが検討・試行されましたが、サンドボックス環境の制約により、最終的に単一ファイルで全処理を完結させる方式に決定しました。

1.  **ファイル生成数の上限:** `chromedp`の`UserDataDir`機能や、セッション情報をファイル(`cookies.json`)に書き出す方法は、サンドボックスが許容するファイル生成数の上限を超えてしまい、実行時エラーの原因となりました。
2.  **外部パッケージの依存関係解決:** クッキーを手動で処理するために必要な`network`パッケージの追加が、`go mod tidy`や`go get`コマンドのエラーにより困難でした。

これらの問題を根本的に回避するため、以下の特徴を持つ**モノリシック・インメモリセッション方式**を採用します。

- **単一プログラム:** ログイン、URL取得、リアクション送信といった一連の処理を、すべて`main.go`という一つのプログラム内で実行します。
- **インメモリセッション:** `chromedp`のインスタンスを一度だけ起動し、プログラムが終了するまでセッション情報（クッキー等）をメモリ上で保持します。これにより、ファイルI/Oが不要となり、環境の制約を受けません。

## 3. 機能一覧

### 3.1. アクション

スクリプトは `-action` フラグによって動作モードを切り替えます。

| アクション名 | 説明 |
| :--- | :--- |
| `react-timeline` | フォローしているユーザーのタイムラインを巡回し、未リアクションの投稿に「いいね！」します。 |
| `react-activities` | 特定のユーザー（自分など）の活動日記一覧ページを巡回し、未リアクションの投稿に「いいね！」します。 |

### 3.2. 環境設定 (`generate_env.sh`)

`generate_env.sh` スクリプトは、環境変数から `.env` ファイルを生成するために使用されます。これにより、CI/CD環境などでシークレットを安全にファイルに書き出すことができます。

## 4. CSS/JSセレクタ一覧

スクレイピングの安定性を高めるため、動的に変化する`class`名ではなく、`data-testid`や`aria-label`などの安定した属性、またはJavaScriptによるデータ抽出を優先的に使用します。

### 4.1. ログインページ (`/login`)

| 要素名 | セレクタ | 備考 |
| :--- | :--- | :--- |
| メールアドレス入力 | `input[name="email"]` | |
| パスワード入力 | `input[name="password"]` | |
| ログインボタン | `button[type="submit"]` | JavaScriptでクリック (`document.querySelector(...).click()`) |

### 4.2. タイムラインページ (`/timeline`)

タイムラインのデータは、HTML解析ではなく、ページ内のJavaScriptオブジェクト (`window.__NUXT__`) から直接抽出します。

| データソース | パス |
| :--- | :--- |
| フィードデータ | `window.__NUXT__.state.timeline.feeds` |

### 4.3. 活動日記一覧ページ (`/search/activities`)

| 要素名 | セレクタ |
| :--- | :--- |
| 活動エントリ | `[data-testid="activity-entry"] a[href^="/activities/"]` |

### 4.4. 活動日記詳細ページ (`/activities/{id}`)

| 要素名 | セレクタ |
| :--- | :--- |
| リアクションボタン | `.emoji-add-button` |
| 絵文字ピッカー | `.emojiPickerBody` |
| 絵文字ボタン | `.emojiButton.emoji-button:first-child`, `.emoji-picker-button:first-child` |

## 5. 実装状況

全ての主要機能は実装済みです。

1.  **ログイン機能:** `main.go` 内の `login` 関数で実装済み。
2.  **タイムライン巡回:** `main.go` 内の `runTimelineReaction`, `processTimeline` 関数で実装済み（`window.__NUXT__` 利用）。
3.  **活動日記一覧巡回:** `main.go` 内の `runActivitiesReaction`, `processActivities` 関数で実装済み。
4.  **リアクション送信:** `main.go` 内の `sendReaction` 関数で実装済み。
5.  **環境変数生成:** `generate_env.sh` で実装済み。