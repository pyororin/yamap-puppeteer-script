# YAMAPタイムライン巡回スクリプト 設計仕様書 (最終版)

## 1. 概要

このドキュメントは、YAMAPタイムライン巡回スクリプトの最終的な技術仕様を定義します。スクリプトは指定されたYAMAPの活動日記ページを巡回し、まだリアクションを送っていない投稿に自動で「DOMO」絵文字を送ることを目的とします。

## 2. アーキテクチャ

### 2.1. 最終的な技術スタック

- **言語:** Go
- **ライブラリ:** `github.com/chromedp/chromedp`
- **実行方式:** **モノリシック・インメモリセッション方式**

### 2.2. アーキテクチャ決定の経緯と理由

開発初期段階において、複数のアプローチが検討・試行されましたが、サンドボックス環境の以下の厳しい制約により、最終的に単一ファイルで全処理を完結させる方式に決定しました。

1.  **ファイル生成数の上限:** `chromedp`の`UserDataDir`機能や、セッション情報をファイル(`cookies.json`)に書き出す方法は、サンドボックスが許容するファイル生成数の上限を超えてしまい、実行時エラーの原因となりました。
2.  **外部パッケージの依存関係解決:** クッキーを手動で処理するために必要な`network`パッケージの追加が、`go mod tidy`や`go get`コマンドのエラーにより困難でした。

これらの問題を根本的に回避するため、以下の特徴を持つ**モノリシック・インメモリセッション方式**を採用します。

- **単一プログラム:** ログイン、URL取得、リアクション送信といった一連の処理を、すべて`send_reaction.go`という一つのプログラム内で実行します。
- **インメモリセッション:** `chromedp`のインスタンスを一度だけ起動し、プログラムが終了するまでセッション情報（クッキー等）をメモリ上で保持します。これにより、ファイルI/Oが不要となり、環境の制約を受けません。

## 3. CSSセレクタ一覧

スクレイピングの安定性を高めるため、動的に変化する`class`名ではなく、`data-testid`や`aria-label`などの安定した属性を優先的に使用します。

### 3.1. ログインページ (`/login`)

| 要素名 | セレクタ |
| :--- | :--- |
| メールアドレス入力 | `input[name="email"]` |
| パスワード入力 | `input[name="password"]` |
| ログインボタン | `button[data-testid="login-button"]` |

### 3.2. 活動日記ページ (`/activities/{id}`)

| 要素名 | セレクタ | 特定方法 |
| :--- | :--- | :--- |
| リアクションボタン | `button[aria-label="絵文字をおくる"]` | 特定済み |
| **絵文字選択パネル** | **`[data-testid="emoji-picker"]`** | **TBD:** `send_reaction.go`のデバッグ実行でHTMLを取得し、内部構造を解析して最終特定 |
| **DOMO絵文字ボタン** | **TBD** | **TBD:** 上記で取得したHTMLから、DOMO絵文字に対応するボタンのセレクタを特定 |
| **リアクション送信済み判定**| **TBD** | **TBD:** 既にDOMOを送った投稿をスキップするため、送信済み状態を示す要素・クラス・属性を特定 |

## 4. 実装計画

1.  **デバッグ機能の実装:** まず`send_reaction.go`に、ログインから活動日記ページに遷移し、「絵文字をおくる」ボタンをクリックして絵文字ピッカーを表示させ、その時点でのHTMLをファイルに出力する機能を実装します。
2.  **セレクタの最終特定:** 出力されたHTMLを分析し、上記「TBD」となっているセレクタをすべて特定し、この仕様書を更新します。
3.  **リアクション機能の実装:** 特定したセレクタを用いて、リアクションの送信、送信済み投稿のスキップといった本番ロジックを`send_reaction.go`に実装します。
4.  **完成:** `README.md`を作成し、プロジェクトを完成させます。